<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>豆瓣电影</title>
    <link rel="stylesheet" href="./index.css">
</head>

<body>
    <main>
        <section id="top250">
            <div class="container"></div>
            <div class="loading"><span class="iconfont ">vv</span></div>
        </section>
        <section id="beimei">
            <div class="loading"><span class="iconfont "></span></div>
        </section>
        <section id="search">
            <div class="loading"><span class="iconfont "></span></div>
        </section>
    </main>
    <footer>
        <div class="active">
            <span class="icon">x
            </span>
            <span>top250</span>
        </div>
        <div>
            <span class="icon">x
            </span>
            <span>北美</span>
        </div>
        <div>
            <span class="icon">x
            </span>
            <span>搜索</span>
        </div>
    </footer>

    <script src="./vendors/jquery.min.js"></script>

    <script>
        var Top250page = {
            init: function () {
                this.$container = $('#top250')//视口
                this.$content = this.$container.find('.container')//内容
                this.index = 0;
                this.isLoading = false
                this.isFinish = false
                this.bind()
                this.start() //一开始就请求一次
            },
            bind: function () {
                var _this = this
                //懒加载
                this.$container.on('scroll', function () {
                    if (!_this.isFinish && common.isToEnd($container, $content)) {
                        _this.start()
                    }
                })
            },
            start: function(){
                var _this= this
                this.getData(function(data){
                    _this.render(data)
                })
            },
            //jsonp请求
            getData: function (callback) {
                var _this= this
                if (_this.isLoading) return
                _this.isLoading = true
                _this.$container.find('.loading').show()
                $.ajax({
                    url: 'https://api.douban.com/v2/movie/top250',
                    data: {
                        start: this.index || 0,
                        count: 20
                    },
                    dataType: 'jsonp'
                }).done(function (ret) {
                    console.log(ret)
                    callback && callback(ret)
                    _this.index += 20
                    if (_this.index >= ret.total) {
                        _this.isFinish = true
                    }
                }).fail(function () {
                    console.log('数据异常')
                }).always(function () {
                    _this.isLoading = false
                    _this.$container.find('.loading').hide()
                })
            },
            //渲染
            render: function (data) {
                var _this = this
                data.subjects.forEach(function (movie) {
                    _this.$content.append(common.createNode(movie))
                })
            }
        }

        var common = {
            isToEnd: function ($viewport, $conent) {
                return $viewport.height() + $viewport.scrollTop() > $content.height() - 10
            },
            //节点创建 
            createNode: function (movie) {
                var template = `
                <div class="item">
                    <a href="#">
                        <div class="cover">
                            <img src="" alt="">
                        </div>
                        <div class="detail">
                            <h2></h2>
                            <div class="extra"><span class="score"></span>分 / <span class="collect"></span>收藏</div>
                            <div class="extra"><span class="year"></span> / <span class="type"></span></div>
                            <div class="extra">导演: <span class="director"></span></div>
                            <div class="extra">主演: <span class="actor"></span></div>
                        </div>
                    </a>
                </div>
        `
                var $node = $(template)
                $node.find('a').attr('href', movie.alt)
                $node.find('.cover img').attr('src', movie.images.medium)
                $node.find('.detail h2').text(movie.title)
                $node.find('.score').text(movie.rating.average)
                $node.find('.collect').text(movie.collect_count)
                $node.find('.year').text(movie.year)
                $node.find('.type').text(movie.genres.join(' / '))
                $node.find('.director').text(function () {
                    var directorsArr = []
                    movie.directors.forEach(function (item) {
                        directorsArr.push(item.name)
                    })
                    return directorsArr.join('、')
                })
                $node.find('.actor').text(function () {
                    var actorArr = []
                    movie.casts.forEach(function (item) {
                        actorArr.push(item.name)
                    })
                    return actorArr.join('、')
                })
                return $node
            }
        }

        
        var App = {
            init: function(){
                this.bind()
                Top250page.init()
            },
            //tab切换
            bind: function(){

                $('footer>div').on('click', function () {
                $(this).addClass('active')
                    .siblings().removeClass('active')
                $('main>section').hide().eq($(this).index())
                    .fadeIn()
            })
            }
        }
        App.init()

    </script>
</body>

</html>